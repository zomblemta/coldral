{%- comment -%}构建产品颜色数据{%- endcomment -%}
{%- assign color_swatches = '' -%}
{%- assign color_labels = 'color,farve,farbe,couleur,cor,colour' | split: ',' -%}
{%- assign color_option_value = null -%}

{%- comment -%}选择图片的逻辑：优先使用variant_item对应的变体图片{%- endcomment -%}
{%- assign selected_image = product.images[0] -%}

{%- if variant_item != null -%}
  {%- comment -%}如果提供了variant_item，尝试找到对应的产品变体并使用其图片{%- endcomment -%}
  {%- assign found_variant = null -%}
  {%- for variant in product.variants -%}
    {%- if variant.id == variant_item.id -%}
      {%- assign found_variant = variant -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
  
  {%- comment -%}如果通过ID没找到，尝试通过选项值匹配{%- endcomment -%}
  {%- if found_variant == null -%}
    {%- for variant in product.variants -%}
      {%- if variant_item.option1 != blank and variant.option1 == variant_item.option1
        and variant_item.option2 != blank and variant.option2 == variant_item.option2
        and variant_item.option3 != blank and variant.option3 == variant_item.option3
      -%}
        {%- assign found_variant = variant -%}
        {%- break -%}
      {%- elsif variant_item.option1 != blank and variant.option1 == variant_item.option1
        and variant_item.option2 != blank and variant.option2 == variant_item.option2
      -%}
        {%- assign found_variant = variant -%}
        {%- break -%}
      {%- elsif variant_item.option1 != blank and variant.option1 == variant_item.option1 -%}
        {%- assign found_variant = variant -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
  
  {%- if found_variant != null and found_variant.image != blank -%}
    {%- assign selected_image = found_variant.image -%}
  {%- elsif color_option_index != null -%}
    {%- comment -%}如果没找到匹配的变体，根据color_option_index获取对应的颜色值{%- endcomment -%}
    {%- for option in product.options_with_values -%}
      {%- assign option_name_downcase = option.name | downcase -%}
      {%- if color_labels contains option_name_downcase -%}
        {%- capture color_swatches -%}[
          {%- for value in option.values -%}
            {%- assign value_handle = value | handleize -%}
            {%- assign color_metaobject = shop.metaobjects['shopify--color-pattern'][value_handle] -%}
            {
              "name": {{ value | json }},
              "color": {% if color_metaobject.color.value %}{{ color_metaobject.color.value | json }}{% else %}""{% endif %},
              "image": ""
            }{% unless forloop.last %},{% endunless %}
          {%- endfor -%}
        ]{%- endcapture -%}
        {%- comment -%}color_option_index是从1开始的，需要转换为从0开始的索引{%- endcomment -%}
        {%- assign color_option_index_zero = color_option_index | minus: 1 -%}
        {%- if color_option_index_zero >= 0 and color_option_index_zero < option.values.size -%}
          {%- assign color_option_value = option.values[color_option_index_zero] -%}
        {%- endif -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}

    {%- comment -%}根据color_option_value获取对应的变体图片{%- endcomment -%}
    {%- if color_option_value != null -%}
      {%- for variant in product.variants -%}
        {%- if color_option_value == variant.option1
          or color_option_value == variant.option2
          or color_option_value == variant.option3
        -%}
          {%- if variant.image != blank -%}
            {%- assign selected_image = variant.image -%}
            {%- break -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
  {%- endif -%}
{%- elsif color_option_index != null -%}
  {%- comment -%}根据color_option_index获取对应的颜色值{%- endcomment -%}
  {%- for option in product.options_with_values -%}
    {%- assign option_name_downcase = option.name | downcase -%}
    {%- if color_labels contains option_name_downcase -%}
      {%- capture color_swatches -%}[
        {%- for value in option.values -%}
          {%- assign value_handle = value | handleize -%}
          {%- assign color_metaobject = shop.metaobjects['shopify--color-pattern'][value_handle] -%}
          {
            "name": {{ value | json }},
            "color": {% if color_metaobject.color.value %}{{ color_metaobject.color.value | json }}{% else %}""{% endif %},
            "image": ""
          }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ]{%- endcapture -%}
      {%- comment -%}color_option_index是从1开始的，需要转换为从0开始的索引{%- endcomment -%}
      {%- assign color_option_index_zero = color_option_index | minus: 1 -%}
      {%- if color_option_index_zero >= 0 and color_option_index_zero < option.values.size -%}
        {%- assign color_option_value = option.values[color_option_index_zero] -%}
      {%- endif -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}

  {%- comment -%}根据color_option_value获取对应的变体图片{%- endcomment -%}
  {%- if color_option_value != null -%}
    {%- for variant in product.variants -%}
      {%- if color_option_value == variant.option1
        or color_option_value == variant.option2
        or color_option_value == variant.option3
      -%}
        {%- if variant.image != blank -%}
          {%- assign selected_image = variant.image -%}
          {%- break -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
{%- elsif color_options != blank -%}
  {%- comment -%}兼容旧的color_options参数（从1开始的数字）{%- endcomment -%}
  {%- for option in product.options_with_values -%}
    {%- assign option_name_downcase = option.name | downcase -%}
    {%- if color_labels contains option_name_downcase -%}
      {%- capture color_swatches -%}[
        {%- for value in option.values -%}
          {%- assign value_handle = value | handleize -%}
          {%- assign color_metaobject = shop.metaobjects['shopify--color-pattern'][value_handle] -%}
          {
            "name": {{ value | json }},
            "color": {% if color_metaobject.color.value %}{{ color_metaobject.color.value | json }}{% else %}""{% endif %},
            "image": ""
          }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ]{%- endcapture -%}
      {%- assign color_options_num = color_options | plus: 0 -%}
      {%- if color_options_num > 0 and color_options_num <= option.values.size -%}
        {%- assign color_option_index_zero = color_options_num | minus: 1 -%}
        {%- assign color_option_value = option.values[color_option_index_zero] -%}
      {%- endif -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if color_option_value != null -%}
    {%- for variant in product.variants -%}
      {%- if color_option_value == variant.option1
        or color_option_value == variant.option2
        or color_option_value == variant.option3
      -%}
        {%- if variant.image != blank -%}
          {%- assign selected_image = variant.image -%}
          {%- break -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
{%- endif -%}

<div class="alp-product-small-look-item">
  <div class="alp-product-small-look-item-image">
    {% render 'alp-responsive-image', image: selected_image %}
    {%- comment -%}Quick-add 按钮功能{%- endcomment -%}
    {%- if product.available -%}
      <div class="alp-product-small-look-item-button">
        {%- liquid
          assign default_variant = product.selected_or_first_available_variant
          assign is_single_variant = false
          if product.variants.size == 1 and product.selling_plan_groups.size == 0
            assign is_single_variant = true
          endif
        -%}
        
        {%- if is_single_variant -%}
          {%- comment -%}单个变体：直接添加到购物车{%- endcomment -%}
          <product-form>
            {%- form 'product', product -%}
              <input type="hidden" name="id" value="{{ default_variant.id }}">
              <button type="submit" class="alp-product-small-look-item-quick-add-button" aria-label="{{ 'product.general.add_to_cart_button' | t }}">
                <span class="sr-only">{{ 'product.general.add_to_cart_button' | t }}</span>
                {%- render 'icon' with 'plus' -%}
              </button>
            {%- endform -%}
          </product-form>
        {%- else -%}
          {%- comment -%}多个变体：打开 quick-buy 模态框{%- endcomment -%}
          {%- liquid
            # 生成唯一的 ID，使用 product.id 和 unique_id（如果提供）
            if unique_id != blank
              assign quick_buy_id = 'quick-buy-alp-' | append: product.id | append: '-' | append: unique_id
            else
              # 如果没有提供 unique_id，使用随机数确保唯一性
              assign random_suffix = product.id | append: 'x' | append: forloop.index | default: 'default'
              assign quick_buy_id = 'quick-buy-alp-' | append: product.id | append: '-' | append: random_suffix
            endif
          -%}
          <button 
            type="button" 
            class="alp-product-small-look-item-quick-add-button" 
            aria-controls="{{ quick_buy_id }}"
            aria-label="{{ 'product.general.choose_options' | t }}"
            data-quick-buy-id="{{ quick_buy_id }}"
          >
            <span class="sr-only">{{ 'product.general.choose_options' | t }}</span>
            {%- render 'icon' with 'plus', class: 'w-[16px] h-[16px]' -%}
          </button>
          <quick-buy-modal
            handle="{{ product.handle }}{% if default_variant %}?variant={{ default_variant.id }}{% endif %}"
            id="{{ quick_buy_id }}"
            class="quick-buy-modal modal"
          ></quick-buy-modal>
        {%- endif -%}
      </div>
    {%- endif -%}
  </div>
    <div class="alp-product-small-look-item-content ">
      <h3 class="alp-product-small-look-item-content-title">
        <a href="{{ product.url }}" class="alp-product-small-look-item-title-link">
          {{ product.title }}
        </a>
      </h3>
      <div class="alp-product-small-look-item-content-price-container">
        <span class="alp-product-small-look-item-content-price">{{ product.price | money }}</span>
        {% if product.compare_at_price > product.price %}
          <span class="alp-product-small-look-item-content-compare-at-price">{{ product.compare_at_price | money }}</span>
        {% endif %}
      </div>
  </div>
</div>
